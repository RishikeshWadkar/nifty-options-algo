graph TD
    A[üçé MacBook Starts Bot] --> B{üîß Select Mode}
    
    B -->|üìä Backtest| BT[üìà Backtesting Flow]
    B -->|üìù Paper Trading| PT[üé≠ Paper Trading Flow]  
    B -->|üí∞ Live Trading| LT[üöÄ Live Trading Flow]
    
    %% BACKTESTING FLOW
    BT --> BT1[üìÅ Load Historical Data]
    BT1 --> BT2{üíæ Data Available?}
    BT2 -->|‚ùå No Data| BT3[üîÑ Download from Shoonya API]
    BT2 -->|‚úÖ Data Found| BT4[‚ö° Fast Replay Mode]
    BT3 --> BT4
    BT4 --> BT5[üìä Generate Performance Metrics]
    BT5 --> BT6[üíæ Save Results to DB]
    BT6 --> END1[‚úÖ Backtesting Complete]
    
    %% PAPER TRADING FLOW
    PT --> PT1[üì° Connect to Shoonya API]
    PT1 --> PT2{üîó Connection OK?}
    PT2 -->|‚ùå API Down| PT3[üìß Send Alert: API Down]
    PT2 -->|‚úÖ Connected| PT4[üîå Start WebSocket]
    PT3 --> PT31[‚è∞ Wait 30s & Retry]
    PT31 --> PT1
    
    PT4 --> PT5{üåê WebSocket OK?}
    PT5 -->|‚ùå WS Failed| PT6[üìß Alert: WebSocket Failed]
    PT5 -->|‚úÖ WS Connected| PT7[üìä Start Paper Simulation]
    PT6 --> PT61[üîÑ Auto-Reconnect Logic]
    PT61 --> PT4
    
    PT7 --> PT8[üíæ Track Simulated Positions]
    PT8 --> MAIN[üéØ Main Trading Logic]
    
    %% LIVE TRADING FLOW  
    LT --> LT1[üîê Authenticate with 2FA]
    LT1 --> LT2{üîë Auth Success?}
    LT2 -->|‚ùå Auth Failed| LT3[üö® CRITICAL Alert: Auth Failed]
    LT2 -->|‚úÖ Authenticated| LT4[üí∞ Enable Live Trading Mode]
    LT3 --> LT31[üõë Emergency Stop]
    LT31 --> END2[‚ùå Bot Stopped - Manual Intervention Required]
    
    LT4 --> LT5[üì° Connect to Live API]
    LT5 --> LT6{üîó Live Connection OK?}
    LT6 -->|‚ùå Connection Failed| LT7[üö® CRITICAL Alert: Live API Down]
    LT6 -->|‚úÖ Connected| LT8[üí∞ Start Live Trading]
    LT7 --> LT71[‚è∞ Emergency Mode: Wait & Retry]
    LT71 --> LT5
    
    LT8 --> MAIN
    
    %% MAIN TRADING LOGIC (Common for Paper & Live)
    MAIN --> M1[üìä Collect Market Data]
    M1 --> M2{üåê Data Feed OK?}
    
    M2 -->|‚ùå No Data| M3[üìß Alert: Data Feed Lost]
    M2 -->|‚úÖ Data Flowing| M4[üïò Check Market Hours]
    M3 --> M31[üîÑ Auto-Reconnect WebSocket]
    M31 --> M32{üîÑ Reconnect Success?}
    M32 -->|‚úÖ Reconnected| M4
    M32 -->|‚ùå Still Failed| M33[üö® CRITICAL Alert: Data Feed Down]
    M33 --> M34[‚è∞ Wait 60s & Retry]
    M34 --> M31
    
    M4 --> M5{üïò Market Open?}
    M5 -->|‚ùå Market Closed| M6[üò¥ Sleep Mode]
    M5 -->|‚úÖ Market Open| M7[üìè Calculate Zones]
    M6 --> M61[‚è∞ Wait Until Market Opens]
    M61 --> M4
    
    M7 --> M8{üìä Zone Calculation OK?}
    M8 -->|‚ùå Calculation Failed| M9[üìß Alert: Zone Calculation Failed]
    M8 -->|‚úÖ Zones Ready| M10[üéØ Monitor for Signals]
    M9 --> M91[üîÑ Retry Zone Calculation]
    M91 --> M7
    
    M10 --> M11{üìà Signal Generated?}
    M11 -->|‚ùå No Signal| M10
    M11 -->|‚úÖ Signal Found| M12[‚öñÔ∏è Risk Management Check]
    
    M12 --> M13{üõ°Ô∏è Risk Rules OK?}
    M13 -->|‚ùå Risk Violation| M14[üìß Alert: Trade Blocked by Risk]
    M13 -->|‚úÖ Risk Approved| M15{üîß Trading Mode Check}
    M14 --> M10
    
    M15 -->|üìù Paper Mode| P1[üé≠ Simulate Order]
    M15 -->|üí∞ Live Mode| L1[üì§ Send Real Order]
    
    %% PAPER TRADING EXECUTION
    P1 --> P2[‚úÖ Instant Simulated Fill]
    P2 --> P3[üíæ Update Simulated Portfolio]
    P3 --> P4[üìß Telegram: Paper Trade Executed]
    P4 --> MON[üìä Position Monitoring]
    
    %% LIVE TRADING EXECUTION
    L1 --> L2{üì§ Order Sent OK?}
    L2 -->|‚ùå Send Failed| L3[üö® CRITICAL Alert: Order Send Failed]
    L2 -->|‚úÖ Sent Successfully| L4[‚è∞ Wait for Fill Confirmation]
    L3 --> L31[üîÑ Retry Order Send]
    L31 --> L32{üîÑ Retry Success?}
    L32 -->|‚úÖ Sent| L4
    L32 -->|‚ùå Still Failed| L33[üö® EMERGENCY: Order System Down]
    L33 --> L34[üõë Emergency Shutdown]
    L34 --> END3[‚ùå Emergency Stop - Manual Intervention]
    
    L4 --> L5{‚úÖ Order Filled?}
    L5 -->|‚è∞ Waiting| L6[‚è∞ Wait 10s]
    L5 -->|‚úÖ Filled| L7[üíæ Record Execution]
    L5 -->|‚ùå Rejected| L8[üìß Alert: Order Rejected]
    L6 --> L61{‚è∞ Timeout Reached?}
    L61 -->|‚ùå Keep Waiting| L5
    L61 -->|‚úÖ Timeout| L9[üìß Alert: Order Fill Timeout]
    
    L7 --> L71{üí∞ Fill Price OK?}
    L71 -->|‚ùå Bad Fill Price| L72[üìß Alert: Slippage Warning]
    L71 -->|‚úÖ Good Fill| L73[üìß Telegram: Live Trade Executed]
    L72 --> L73
    L73 --> MON
    
    L8 --> L81[üîç Analyze Rejection Reason]
    L81 --> L82{üîç Reason Analysis}
    L82 -->|üí∞ Insufficient Funds| L83[üö® CRITICAL: Insufficient Funds]
    L82 -->|üïò Market Closed| L84[üìß Alert: Market Closed Order]
    L82 -->|‚ö° Rate Limit| L85[‚è∞ Wait & Retry]
    L82 -->|‚ùì Unknown Reason| L86[üìß Alert: Unknown Rejection]
    L83 --> L87[üõë Emergency Shutdown]
    L84 --> M10
    L85 --> L1
    L86 --> M10
    L87 --> END4[‚ùå Critical Stop - Check Funds]
    
    L9 --> L91[‚ùì Check Order Status]
    L91 --> L92{‚ùì Order Status}
    L92 -->|‚úÖ Actually Filled| L7
    L92 -->|‚è∞ Still Pending| L93[‚ùå Cancel Pending Order]
    L92 -->|‚ùå Actually Rejected| L8
    L93 --> M10
    
    %% POSITION MONITORING (Common for Both Modes)
    MON --> MON1[üìä Monitor Position]
    MON1 --> MON2{üéØ Exit Condition?}
    
    MON2 -->|‚ùå Hold Position| MON3[üìä Update Trailing SL]
    MON2 -->|‚úÖ SL Hit| MON4[üö™ Exit via Stop Loss]
    MON2 -->|‚úÖ TP Hit| MON5[üö™ Exit via Take Profit]
    MON2 -->|‚úÖ Manual Exit| MON6[üö™ Manual Exit Signal]
    
    MON3 --> MON1
    
    MON4 --> MON7{üîß Exit Mode}
    MON5 --> MON7
    MON6 --> MON7
    
    MON7 -->|üìù Paper Mode| MON8[üé≠ Simulate Exit]
    MON7 -->|üí∞ Live Mode| MON9[üì§ Send Exit Order]
    
    MON8 --> MON10[üíæ Record Paper Exit]
    MON10 --> MON11[üìä Calculate Paper P&L]
    MON11 --> MON12[üìß Telegram: Paper Position Closed]
    MON12 --> RPT[üìà Generate Reports]
    
    MON9 --> MON13{üì§ Exit Order Sent?}
    MON13 -->|‚ùå Send Failed| MON14[üö® CRITICAL: Exit Order Failed]
    MON13 -->|‚úÖ Sent| MON15[‚è∞ Wait for Exit Fill]
    MON14 --> MON141[üîÑ Retry Exit Order]
    MON141 --> MON9
    
    MON15 --> MON16{‚úÖ Exit Filled?}
    MON16 -->|‚úÖ Filled| MON17[üíæ Record Live Exit]
    MON16 -->|‚ùå Not Filled| MON18[üìß Alert: Exit Fill Issue]
    MON16 -->|‚è∞ Waiting| MON19[‚è∞ Wait 10s]
    
    MON17 --> MON20[üìä Calculate Live P&L]
    MON18 --> MON181[üîç Check Exit Order Status]
    MON19 --> MON16
    MON181 --> MON9
    
    MON20 --> MON21[üìß Telegram: Live Position Closed]
    MON21 --> RPT
    
    %% REPORTING & ALERTS
    RPT --> RPT1[üìä Update Performance Metrics]
    RPT1 --> RPT2[üíæ Save Trade to Database]
    RPT2 --> RPT3{üìä Daily Limits Check}
    
    RPT3 -->|‚úÖ Within Limits| RPT4[üìß Trade Summary Alert]
    RPT3 -->|‚ùå Limit Exceeded| RPT5[üö® HALT: Daily Limit Reached]
    
    RPT4 --> RPT6[üìà Update Dashboard Data]
    RPT5 --> RPT51[üõë Emergency Shutdown]
    RPT51 --> END5[‚è∏Ô∏è Bot Halted - Daily Limit Reached]
    
    RPT6 --> RPT7{üïò Market Still Open?}
    RPT7 -->|‚úÖ Market Open| M10
    RPT7 -->|‚ùå Market Closed| RPT8[üìß Daily Summary Email]
    RPT8 --> RPT9[üò¥ End of Day Shutdown]
    RPT9 --> END6[‚úÖ Normal Daily Shutdown]
    
    %% INTERNET CONNECTIVITY MONITORING
    subgraph "üåê Background Internet Monitor"
        NET1[üåê Ping Test Every 30s]
        NET1 --> NET2{üì∂ Internet OK?}
        NET2 -->|‚úÖ Connected| NET1
        NET2 -->|‚ùå Disconnected| NET3[üö® CRITICAL: Internet Down]
        NET3 --> NET4[üì± Try Mobile Hotspot Alert]
        NET4 --> NET5[‚è∞ Wait for Reconnection]
        NET5 --> NET1
    end
    
    %% SYSTEM HEALTH MONITORING
    subgraph "üè• Background Health Monitor"
        HEALTH1[üè• System Check Every 60s]
        HEALTH1 --> HEALTH2{üíª System Health OK?}
        HEALTH2 -->|‚úÖ Healthy| HEALTH1
        HEALTH2 -->|‚ö†Ô∏è High CPU/Memory| HEALTH3[üìß Performance Warning]
        HEALTH2 -->|üî• Critical Issues| HEALTH4[üö® System Critical Alert]
        HEALTH3 --> HEALTH1
        HEALTH4 --> HEALTH5[üõë Protective Shutdown]
        HEALTH5 --> END7[‚ùå System Protection Shutdown]
    end
    
    %% Styling
    classDef startEnd fill:#e1f5fe,stroke:#01579b,stroke-width:3px
    classDef process fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef decision fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef alert fill:#ffebee,stroke:#b71c1c,stroke-width:2px
    classDef critical fill:#ff1744,stroke:#ffffff,stroke-width:3px
    classDef success fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    
    class A,END1,END2,END3,END4,END5,END6,END7 startEnd
    class M1,M7,M10,MON1,RPT1,BT4,PT7,LT8 process
    class B,M2,M5,M8,M11,M13,M15,L2,L5,MON2 decision
    class M3,M9,M14,L3,L8,L9,MON14,MON18,RPT4,NET3,HEALTH3 alert
    class LT3,L33,L83,RPT5,NET4,HEALTH4 critical
    class P2,L7,MON17,RPT6 success